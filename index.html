<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Build Status Informaat CXP</title>
		<link rel="stylesheet" href="components/open-sans-fontface/open-sans.css" type="text/css" charset="utf-8">
		<link rel="stylesheet" href="styles/styles.css" type="text/css" charset="utf-8">
	</head>

	<body>
		<div id="Builds">
			<h1>Informaat CXP Dashboard</h1>
			<table>
				<thead>
					<tr>
						<th class="icon" ></th>
						<th class="name" >Branch</th>
						<th class="client">Client</th>
						<th class="server">Server</th>
						<th class="mesg" >Message</th>
						<th class="person">By</th>
						<th class="time">Commit</th>
					</tr>
				</thead>
				<tbody data-bind="foreach: $root">
					<tr data-bind="css: {'success': buildSuccess, failure: buildFailed, pending: buildPending}">
						<td></td>
						<td data-bind="text: name"></td>
						<td class="number" data-bind="css: {'low-coverage': coverages.clientLow, 'coverage-ok': !coverages.clientLow()}"><span data-bind="text: coverages.client"></span></td>
						<td class="number" data-bind="css: {'low-coverage': coverages.serverLow, 'coverage-ok': !coverages.serverLow()}"><span data-bind="text: coverages.server"></span></td>
						<td data-bind="text: buildStatus.message"></td>
						<td data-bind="text: buildStatus.person"></td>
						<td data-bind="text: buildStatus.time" class="time"></td>
					</tr>
				</tbody>
			</table>
		</div>

		<div id="Burndowns">
			<!-- UI -->
			<img src="https://docs.google.com/spreadsheet/oimg?key=0AoMLeMpVOVUCdE11REFCOXRtREg4dmZYel9ORmsyYmc&oid=2&zx=wdzqarfw5pjw" />

			<!-- OPS -->
			<img src="https://docs.google.com/spreadsheet/oimg?key=0AoMLeMpVOVUCdHlQUnZIaFRzUFlxZUxUQXk5QmNhaGc&oid=2&zx=1lbrmi8mktu" />

			<!-- UX -->
			<img src="https://docs.google.com/spreadsheet/oimg?key=0AqQCMQcuIHJkdHphVWlJTmlBOHpWcWdzNHdCUGtQUFE&oid=2&zx=d348is958ie1" />
		</div>

		<iframe id="Ops" src="http://hudson.local:1984"></iframe>
		
		<script src="components/jquery/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="components/humane-dates/humane.js" type="text/javascript" charset="utf-8"></script>
		<script src="components/knockout/build/output/knockout-latest.js" type="text/javascript" charset="utf-8"></script>
		<script src="components/knockout.mapping/build/output/knockout.mapping-latest.js" type="text/javascript" charset="utf-8"></script>
		
		<script src="scripts/index.js"></script>

		<script type="text/javascript" charset="utf-8">
			var VISIBLE;
			var BUILDS = true;

			var $burn = $('#Burndowns');
			var $blds = $('#Builds');
			var $ops  = $('#Ops');

			var reload = 3;	// reload every 3 minutes
			var toggle = 1; // toggle every 1 minute

			var show = function(selector) {
				$('#Builds, #Burndowns').hide();
				$(selector).show();

				VISIBLE = selector;
			}

			 var timer = function() {
				// Returns a string like 1501 for 15:01, so it is easy to compare..
				var now = (new Date().getHours() * 100 + new Date().getMinutes());
			 	return (now >= 925 && now <= 950) ? show('#Burndowns') : show('#Builds');
			 }

			 // The page reloads every 3 minutes, but we could also check on load as the page reloads every 10
			 var id = (timer(), setInterval(timer, reload*60*1000));

			// If we are NOT in Burndown mode, toggle between builds and dashboard every minute
			var opstimer = setInterval(function ops() {
				if('#Burndowns' !== VISIBLE) {
					return (BUILDS) ? ($ops.show(), $blds.hide(), BUILDS=false) : ($ops.hide(), $blds.show(), BUILDS=true);
				}
			}, toggle*60*1000);

			console.info('Page polls Jenkins every %d minutes, interval id is: %d', reload, id);
			console.info('Page toggles between Builds and Ops every %d minutes, interval id is: %d', toggle, opstimer);
		</script>
	</body>
</html>
